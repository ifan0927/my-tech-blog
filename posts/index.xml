<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Posts on I-Fan's Tech Blog</title><link>https://ifan0927.github.io/my-tech-blog/posts/</link><description>Recent content in Posts on I-Fan's Tech Blog</description><generator>Hugo -- gohugo.io</generator><language>zh-tw</language><lastBuildDate>Wed, 26 Nov 2025 00:00:00 +0000</lastBuildDate><atom:link href="https://ifan0927.github.io/my-tech-blog/posts/index.xml" rel="self" type="application/rss+xml"/><item><title>API Development Workflow &amp; Electric Reading System Implementation</title><link>https://ifan0927.github.io/my-tech-blog/posts/2025-11-26_note/</link><pubDate>Wed, 26 Nov 2025 00:00:00 +0000</pubDate><guid>https://ifan0927.github.io/my-tech-blog/posts/2025-11-26_note/</guid><description>&lt;p&gt;Today focused on establishing a systematic API development workflow and implementing the electric reading system for property management. The process involved designing DTOs, mappers, and identifying database optimization opportunities.&lt;/p&gt;
&lt;h2 id="api-development-workflow"&gt;API Development Workflow&lt;/h2&gt;
&lt;p&gt;Established a standardized approach for basic GET API development, leveraging the existing modal/repository structure and referencing the legacy system for requirements:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;Requirements Analysis&lt;/strong&gt;: Identify response needs and required modal data&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;DTO Design&lt;/strong&gt;: Create response DTOs and corresponding mappers&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Service Layer Design&lt;/strong&gt;: Plan repository calls and implement missing methods if needed&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Route Registration&lt;/strong&gt;: Register mappers and configure routes&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;This systematic approach ensures consistency across the codebase while facilitating the migration from the legacy system.&lt;/p&gt;</description><content type="html"><![CDATA[<p>Today focused on establishing a systematic API development workflow and implementing the electric reading system for property management. The process involved designing DTOs, mappers, and identifying database optimization opportunities.</p>
<h2 id="api-development-workflow">API Development Workflow</h2>
<p>Established a standardized approach for basic GET API development, leveraging the existing modal/repository structure and referencing the legacy system for requirements:</p>
<ol>
<li><strong>Requirements Analysis</strong>: Identify response needs and required modal data</li>
<li><strong>DTO Design</strong>: Create response DTOs and corresponding mappers</li>
<li><strong>Service Layer Design</strong>: Plan repository calls and implement missing methods if needed</li>
<li><strong>Route Registration</strong>: Register mappers and configure routes</li>
</ol>
<p>This systematic approach ensures consistency across the codebase while facilitating the migration from the legacy system.</p>
<h2 id="database-schema-review">Database Schema Review</h2>
<p>During development, discovered redundant columns in the <code>Electric_reading</code> table that contain empty data after migration. Added this to the TODO list for future table structure optimization, particularly investigating the source and usage of the <code>note</code> field.</p>
<h2 id="electric-reading-system-implementation">Electric Reading System Implementation</h2>
<p>Implemented the core electric reading functionality that returns room reading data for a given property, starting from the current year-month and projecting forward.</p>
<h3 id="data-flow-logic">Data Flow Logic</h3>
<ul>
<li>Input: <code>estateId</code> → Extract room ID list</li>
<li>Fetch active leases for rooms → Get <code>initialReading</code> (empty if no active lease)</li>
<li>Query electric reading records by room ID</li>
<li>Format reading dates as <code>YYYY_MM_DD</code></li>
</ul>
<h3 id="dto-structure">DTO Structure</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">electric_reading</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ElectricReadingListDto</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">RoomID</span>         <span style="color:#66d9ef">int</span>       <span style="color:#e6db74">`json:&#34;room_id&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">InitialReading</span> <span style="color:#66d9ef">float64</span>   <span style="color:#e6db74">`json:&#34;initial_reading&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">EndYear</span>        <span style="color:#66d9ef">int</span>       <span style="color:#e6db74">`json:&#34;end_year&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">EndMonth</span>       <span style="color:#66d9ef">int</span>       <span style="color:#e6db74">`json:&#34;end_month&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ReadList</span>       []<span style="color:#a6e22e">Reading</span> <span style="color:#e6db74">`json:&#34;ReadList&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Reading</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ReadingYear</span>  <span style="color:#66d9ef">int</span>     <span style="color:#e6db74">`json:&#34;reading_year&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ReadingMonth</span> <span style="color:#66d9ef">int</span>     <span style="color:#e6db74">`json:&#34;reading_month&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ReadingValue</span> <span style="color:#66d9ef">float64</span> <span style="color:#e6db74">`json:&#34;reading_value&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="mapper-implementation">Mapper Implementation</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">electric_reading</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">modal</span> <span style="color:#e6db74">&#34;backend/models/property&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">ToElectricReadingListItemDto</span>(
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">electricReading</span> []<span style="color:#a6e22e">modal</span>.<span style="color:#a6e22e">ElectricReading</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">initialReading</span> <span style="color:#66d9ef">float64</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">roomId</span> <span style="color:#66d9ef">int</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">endYear</span> <span style="color:#66d9ef">int</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">endMonth</span> <span style="color:#66d9ef">int</span>) (<span style="color:#a6e22e">ElectricReadingListDto</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ElectricReadingListDto</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ElectricReadingListDto</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">RoomID</span>:         <span style="color:#a6e22e">roomId</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">EndYear</span>:        <span style="color:#a6e22e">endYear</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">EndMonth</span>:       <span style="color:#a6e22e">endMonth</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">InitialReading</span>: <span style="color:#a6e22e">initialReading</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">readingList</span> <span style="color:#f92672">:=</span> make([]<span style="color:#a6e22e">Reading</span>, <span style="color:#ae81ff">0</span>, len(<span style="color:#a6e22e">electricReading</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">reading</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">electricReading</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">read</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Reading</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">ReadingMonth</span>: int(<span style="color:#a6e22e">reading</span>.<span style="color:#a6e22e">ReadingDate</span>.<span style="color:#a6e22e">Month</span>()),
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">ReadingYear</span>:  <span style="color:#a6e22e">reading</span>.<span style="color:#a6e22e">ReadingDate</span>.<span style="color:#a6e22e">Year</span>(),
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">ReadingValue</span>: <span style="color:#a6e22e">reading</span>.<span style="color:#a6e22e">ReadingValue</span>,
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">readingList</span> = append(<span style="color:#a6e22e">readingList</span>, <span style="color:#a6e22e">read</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ElectricReadingListDto</span>.<span style="color:#a6e22e">ReadList</span> = <span style="color:#a6e22e">readingList</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ElectricReadingListDto</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="quick-reference-notes">Quick Reference Notes</h2>
<p>Compiled essential Go conversion and query patterns for REST API development:</p>
<p><strong>Data Conversion:</strong></p>
<ul>
<li>Number to string: <code>strconv.Itoa(n)</code></li>
<li>Unicode to character: <code>string(rune(n))</code></li>
<li>Chinese character count: <code>len([]rune(str))</code></li>
<li>Date calculation: <code>time.AddDate(0, -5, 0)</code></li>
</ul>
<p><strong>API Parameter Binding:</strong></p>
<ul>
<li>Path parameters: <code>c.ShouldBindUri()</code></li>
<li>Query parameters: <code>c.ShouldBindQuery()</code></li>
<li>Default values: <code>c.DefaultQuery(&quot;key&quot;, &quot;default&quot;)</code></li>
</ul>
<p><strong>Database Filtering:</strong></p>
<ul>
<li>Time range queries: <code>WHERE date &gt;= ? AND date &lt; ?</code></li>
</ul>
<h2 id="next-steps">Next Steps</h2>
<ul>
<li>Review and optimize the <code>Electric_reading</code> table structure</li>
<li>Investigate the <code>note</code> field data source and usage</li>
<li>Continue implementing the remaining API endpoints following the established workflow</li>
</ul>
]]></content></item><item><title>Building n8n Automation Workflow for Hugo Blog Content Generation</title><link>https://ifan0927.github.io/my-tech-blog/posts/2025-11-25_note/</link><pubDate>Tue, 25 Nov 2025 00:00:00 +0000</pubDate><guid>https://ifan0927.github.io/my-tech-blog/posts/2025-11-25_note/</guid><description>&lt;p&gt;Today&amp;rsquo;s focus was on establishing an automated n8n workflow to streamline the daily note generation process for Hugo blog posts. The goal was to eliminate manual steps in transforming raw development notes into polished blog content using AI assistance.&lt;/p&gt;
&lt;h2 id="problem-statement"&gt;Problem Statement&lt;/h2&gt;
&lt;p&gt;The current workflow involves several manual steps that create friction in the content creation process:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Daily notes require manual formatting and editing after AI processing&lt;/li&gt;
&lt;li&gt;Hugo post creation involves repetitive file structure setup&lt;/li&gt;
&lt;li&gt;GitHub deployment requires manual commits and pushes&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The solution involves creating an n8n automation that takes raw daily notes, processes them through Claude AI, and automatically creates properly formatted Hugo posts with GitHub integration.&lt;/p&gt;</description><content type="html"><![CDATA[<p>Today&rsquo;s focus was on establishing an automated n8n workflow to streamline the daily note generation process for Hugo blog posts. The goal was to eliminate manual steps in transforming raw development notes into polished blog content using AI assistance.</p>
<h2 id="problem-statement">Problem Statement</h2>
<p>The current workflow involves several manual steps that create friction in the content creation process:</p>
<ol>
<li>Daily notes require manual formatting and editing after AI processing</li>
<li>Hugo post creation involves repetitive file structure setup</li>
<li>GitHub deployment requires manual commits and pushes</li>
</ol>
<p>The solution involves creating an n8n automation that takes raw daily notes, processes them through Claude AI, and automatically creates properly formatted Hugo posts with GitHub integration.</p>
<h2 id="docker-configuration-for-n8n">Docker Configuration for n8n</h2>
<p>Set up n8n with Docker to enable local file access through volume mapping:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#39;3&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">n8n</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">n8nio/n8n</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;5678:5678&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">~/.n8n:/home/node/.n8n</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">/Users/cheni-fan/n8n:/files</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">N8N_BASIC_AUTH_ACTIVE=true</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">N8N_BASIC_AUTH_USER=admin</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">N8N_BASIC_AUTH_PASSWORD=password</span>
</span></span></code></pre></div><p>The key aspect is the volume mapping <code>/Users/cheni-fan/n8n:/files</code> which allows the n8n Read File node to access local development notes. A Code node generates the current date to ensure the correct daily note file is retrieved.</p>
<h2 id="content-processing-workflow">Content Processing Workflow</h2>
<p>After retrieving the raw note content, the workflow processes it through Anthropic&rsquo;s Claude API, followed by a Code node that handles content formatting and metadata generation:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">// Get input data
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">inputData</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">$input</span>.<span style="color:#a6e22e">item</span>.<span style="color:#a6e22e">json</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">content</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">inputData</span>.<span style="color:#a6e22e">content</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">text</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 1. Remove  tags
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">content</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">content</span>.<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">/&lt;\/?markdown_output&gt;/g</span>, <span style="color:#e6db74">&#39;&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 2. Convert 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> <span style="color:#a6e22e">strings</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">actual</span> <span style="color:#a6e22e">line</span> <span style="color:#a6e22e">breaks</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">content</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">content</span>.<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">/\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/g</span>, <span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 3. Clean whitespace
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">content</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">content</span>.<span style="color:#a6e22e">trim</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 4. Extract information from frontmatter for filename generation
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">dateMatch</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">content</span>.<span style="color:#a6e22e">match</span>(<span style="color:#e6db74">/date:\s*&#34;?(\d{4}-\d{2}-\d{2})/</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">titleMatch</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">content</span>.<span style="color:#a6e22e">match</span>(<span style="color:#e6db74">/title:\s*&#34;([^&#34;]+)&#34;/</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 5. Generate filename (slug)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">fileName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">dateMatch</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">titleMatch</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">date</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dateMatch</span>[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fileName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">date</span><span style="color:#e6db74">}</span><span style="color:#e6db74">_Note.md`</span>;
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Fallback: use timestamp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">timestamp</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Date().<span style="color:#a6e22e">toISOString</span>().<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#39;T&#39;</span>)[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fileName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">timestamp</span><span style="color:#e6db74">}</span><span style="color:#e6db74">-post.md`</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 6. Set file path
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">filePath</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`content/posts/</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">fileName</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 7. Prepare commit message
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">commitMessage</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">titleMatch</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">?</span> <span style="color:#e6db74">`Add post: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">titleMatch</span>[<span style="color:#ae81ff">1</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">`</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">:</span> <span style="color:#e6db74">`Add new post: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">fileName</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 8. Output for GitHub node
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">json</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fileContent</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">content</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">filePath</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">filePath</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">commitMessage</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">commitMessage</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fileName</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">fileName</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><h2 id="github-integration">GitHub Integration</h2>
<p>The final step uses n8n&rsquo;s GitHub node to automatically:</p>
<ul>
<li>Create the formatted markdown file in the correct Hugo directory structure</li>
<li>Generate appropriate commit messages based on the post title</li>
<li>Push changes to the repository</li>
</ul>
<p>This automation eliminates the manual steps of file creation, formatting, and deployment, creating a seamless pipeline from raw development notes to published blog content.</p>
<h2 id="next-steps">Next Steps</h2>
<p>The workflow successfully automates the content generation pipeline, but potential enhancements could include:</p>
<ul>
<li>Error handling for API failures</li>
<li>Content validation before publishing</li>
<li>Integration with Hugo&rsquo;s development server for preview generation</li>
<li>Automated social media sharing upon successful deployment</li>
</ul>
]]></content></item><item><title>Go Pointer Handling and Query Optimization in Log Management API</title><link>https://ifan0927.github.io/my-tech-blog/posts/2024-11-25_note/</link><pubDate>Tue, 25 Nov 2025 00:00:00 +0000</pubDate><guid>https://ifan0927.github.io/my-tech-blog/posts/2024-11-25_note/</guid><description>&lt;p&gt;Today&amp;rsquo;s development focused on clarifying Go pointer concepts and optimizing database queries in the log management API. The main achievement was replacing individual database queries with batch operations to improve performance.&lt;/p&gt;
&lt;h2 id="go-pointer-concepts-and-dto-mapping"&gt;Go Pointer Concepts and DTO Mapping&lt;/h2&gt;
&lt;p&gt;Gained better understanding of pointer handling in Go, particularly for DTO mapping scenarios:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Key principle&lt;/strong&gt;: Always check the source data type first&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;&lt;code&gt;&amp;amp;&lt;/code&gt;&lt;/strong&gt;: Takes the address (gets pointer)&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;&lt;code&gt;*&lt;/code&gt;&lt;/strong&gt;: Dereferences (gets value)&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Critical consideration&lt;/strong&gt;: When source is a pointer, always check for &lt;code&gt;nil&lt;/code&gt; before operations&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Type conversion with pointers&lt;/strong&gt;: Must dereference first, then assign to correct pointer type&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This understanding is crucial for safe DTO transformations and avoiding runtime panics.&lt;/p&gt;</description><content type="html"><![CDATA[<p>Today&rsquo;s development focused on clarifying Go pointer concepts and optimizing database queries in the log management API. The main achievement was replacing individual database queries with batch operations to improve performance.</p>
<h2 id="go-pointer-concepts-and-dto-mapping">Go Pointer Concepts and DTO Mapping</h2>
<p>Gained better understanding of pointer handling in Go, particularly for DTO mapping scenarios:</p>
<ul>
<li><strong>Key principle</strong>: Always check the source data type first</li>
<li><strong><code>&amp;</code></strong>: Takes the address (gets pointer)</li>
<li><strong><code>*</code></strong>: Dereferences (gets value)</li>
<li><strong>Critical consideration</strong>: When source is a pointer, always check for <code>nil</code> before operations</li>
<li><strong>Type conversion with pointers</strong>: Must dereference first, then assign to correct pointer type</li>
</ul>
<p>This understanding is crucial for safe DTO transformations and avoiding runtime panics.</p>
<h2 id="database-query-optimization">Database Query Optimization</h2>
<h3 id="problem">Problem</h3>
<p>The original log management GET list API was inefficient - it fetched log IDs first, then performed individual queries for each accounting record.</p>
<h3 id="solution">Solution</h3>
<p>Implemented batch querying strategy to reduce database roundtrips:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">managementLogService</span>) <span style="color:#a6e22e">GetManagementLogListByEstateId</span>(<span style="color:#a6e22e">estateId</span> <span style="color:#66d9ef">int</span>) ([]<span style="color:#a6e22e">dto</span>.<span style="color:#a6e22e">LogsListResponse</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// TODO: Add pagination and filtering</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 1. Get all management logs</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">managementLogs</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">managementLogRepo</span>.<span style="color:#a6e22e">FindByEstateId</span>(uint(<span style="color:#a6e22e">estateId</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#e6db74">&#34;Failed to fetch management logs&#34;</span>, <span style="color:#a6e22e">zap</span>.<span style="color:#a6e22e">Int</span>(<span style="color:#e6db74">&#34;estateId&#34;</span>, <span style="color:#a6e22e">estateId</span>), <span style="color:#a6e22e">zap</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>))
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">managementLogs</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> []<span style="color:#a6e22e">dto</span>.<span style="color:#a6e22e">LogsListResponse</span>{}, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 2. Collect all log IDs</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">logIDs</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">uint</span>, <span style="color:#ae81ff">0</span>, len(<span style="color:#a6e22e">managementLogs</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">log</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">managementLogs</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">logIDs</span> = append(<span style="color:#a6e22e">logIDs</span>, <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">ID</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 3. Batch fetch all related accounting records</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">allAccountings</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">accountRepo</span>.<span style="color:#a6e22e">FindByLogIDs</span>(<span style="color:#a6e22e">logIDs</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#e6db74">&#34;Failed to fetch accountings for logs&#34;</span>, <span style="color:#a6e22e">zap</span>.<span style="color:#a6e22e">Uints</span>(<span style="color:#e6db74">&#34;logIDs&#34;</span>, <span style="color:#a6e22e">logIDs</span>), <span style="color:#a6e22e">zap</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>))
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 4. Group accounting records by log ID</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">accountingMap</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">uint</span>][]<span style="color:#a6e22e">property</span>.<span style="color:#a6e22e">Accounting</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">acc</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">allAccountings</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">acc</span>.<span style="color:#a6e22e">SourceID</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">accountingMap</span>[<span style="color:#f92672">*</span><span style="color:#a6e22e">acc</span>.<span style="color:#a6e22e">SourceID</span>] = append(<span style="color:#a6e22e">accountingMap</span>[<span style="color:#f92672">*</span><span style="color:#a6e22e">acc</span>.<span style="color:#a6e22e">SourceID</span>], <span style="color:#a6e22e">acc</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 5. Compose final results</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> make([]<span style="color:#a6e22e">dto</span>.<span style="color:#a6e22e">LogsListResponse</span>, <span style="color:#ae81ff">0</span>, len(<span style="color:#a6e22e">managementLogs</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">log</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">managementLogs</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Get corresponding accounting records from map (nil slice is safe if not found)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">logAccountings</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">accountingMap</span>[<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">ID</span>]
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">result</span> = append(<span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">dto</span>.<span style="color:#a6e22e">ToLogListItemDto</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">log</span>, <span style="color:#a6e22e">logAccountings</span>))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>Performance benefits</strong>:</p>
<ul>
<li>Reduced N+1 query problem to 2 queries total</li>
<li>Used in-memory grouping instead of multiple database calls</li>
<li>Maintained data consistency with safe nil pointer handling</li>
</ul>
<h2 id="development-environment-improvements">Development Environment Improvements</h2>
<p>The development workflow has significantly improved after implementing remote development setup:</p>
<ul>
<li><strong>Unified environment</strong>: No more device switching concerns</li>
<li><strong>Database consistency</strong>: Eliminated synchronization issues between local environments</li>
<li><strong>Reduced context switching</strong>: Focus on development rather than environment management</li>
</ul>
<p>Database migration is still managed through Go migrations for version control, though the up/down migration process could be more streamlined.</p>
<h2 id="next-steps">Next Steps</h2>
<ol>
<li><strong>Add pagination support</strong> to the log management API</li>
<li><strong>Implement filtering mechanisms</strong> for better query flexibility</li>
<li><strong>Optimize migration workflow</strong> to reduce manual intervention</li>
<li><strong>Consider caching strategies</strong> for frequently accessed log data</li>
</ol>
<p>The current batch query approach provides a solid foundation for these enhancements while maintaining good performance characteristics.</p>
<pre tabindex="0"><code></code></pre>]]></content></item><item><title>Setting Up a Production-Ready Mac Mini M4 Development Environment</title><link>https://ifan0927.github.io/my-tech-blog/posts/2025_11_24_note/</link><pubDate>Mon, 24 Nov 2025 22:51:55 +0800</pubDate><guid>https://ifan0927.github.io/my-tech-blog/posts/2025_11_24_note/</guid><description>&lt;h2 id="introduction"&gt;Introduction&lt;/h2&gt;
&lt;p&gt;When transitioning to a new development machine, especially one intended to serve as both a local workstation and a remote development server, the setup process requires careful planning. This article documents the complete configuration of a Mac mini M4 (24GB) as a full-featured development environment, focusing on remote accessibility, containerized services, and productivity automation through n8n.&lt;/p&gt;
&lt;p&gt;The goal is clear: create a reliable, remotely accessible development hub that supports Go-based backend projects, database management, and workflow automation—all while maintaining clean separation between development tools and system configurations.&lt;/p&gt;</description><content type="html"><![CDATA[<h2 id="introduction">Introduction</h2>
<p>When transitioning to a new development machine, especially one intended to serve as both a local workstation and a remote development server, the setup process requires careful planning. This article documents the complete configuration of a Mac mini M4 (24GB) as a full-featured development environment, focusing on remote accessibility, containerized services, and productivity automation through n8n.</p>
<p>The goal is clear: create a reliable, remotely accessible development hub that supports Go-based backend projects, database management, and workflow automation—all while maintaining clean separation between development tools and system configurations.</p>
<h2 id="core-setup-philosophy">Core Setup Philosophy</h2>
<h3 id="hardware-foundation">Hardware Foundation</h3>
<p>The Mac mini M4 with 24GB RAM provides sufficient resources for running multiple containerized services simultaneously. The ARM64 architecture (Apple Silicon) requires special attention when selecting Docker images and compiling dependencies, but offers excellent performance-per-watt for long-running services.</p>
<h3 id="remote-access-strategy">Remote Access Strategy</h3>
<p>Remote development access is established through:</p>
<ul>
<li><strong>Tailscale VPN</strong>: Provides secure, NAT-traversing connectivity without port forwarding</li>
<li><strong>SSH server</strong>: Enabled through System Settings → General → Sharing → Remote Login</li>
<li><strong>VS Code Remote SSH</strong>: Primary development interface when working remotely</li>
</ul>
<p>This combination eliminates the complexity of dynamic DNS or port forwarding while maintaining security through Tailscale&rsquo;s identity-aware networking.</p>
<h2 id="essential-development-tools">Essential Development Tools</h2>
<h3 id="package-management-and-cli-tools">Package Management and CLI Tools</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Install Homebrew</span>
</span></span><span style="display:flex;"><span>/bin/bash -c <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Core development tools</span>
</span></span><span style="display:flex;"><span>brew install git
</span></span><span style="display:flex;"><span>brew install --cask visual-studio-code
</span></span><span style="display:flex;"><span>brew install go
</span></span><span style="display:flex;"><span>brew install docker
</span></span><span style="display:flex;"><span>brew install --cask docker  <span style="color:#75715e"># Docker Desktop for Mac</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Database clients</span>
</span></span><span style="display:flex;"><span>brew install mysql-client
</span></span><span style="display:flex;"><span>brew install postgresql@14
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Productivity and utilities</span>
</span></span><span style="display:flex;"><span>brew install tmux
</span></span><span style="display:flex;"><span>brew install htop
</span></span><span style="display:flex;"><span>brew install jq
</span></span></code></pre></div><h3 id="database-configuration-mysql">Database Configuration: MySQL</h3>
<p>For Go-based property management projects requiring MySQL:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Install MySQL via Homebrew</span>
</span></span><span style="display:flex;"><span>brew install mysql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Start MySQL service</span>
</span></span><span style="display:flex;"><span>brew services start mysql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Secure installation</span>
</span></span><span style="display:flex;"><span>mysql_secure_installation
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create development database</span>
</span></span><span style="display:flex;"><span>mysql -u root -p
</span></span><span style="display:flex;"><span>CREATE DATABASE property_management_dev CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
</span></span><span style="display:flex;"><span>CREATE USER <span style="color:#e6db74">&#39;dev_user&#39;</span>@<span style="color:#e6db74">&#39;localhost&#39;</span> IDENTIFIED BY <span style="color:#e6db74">&#39;secure_password&#39;</span>;
</span></span><span style="display:flex;"><span>GRANT ALL PRIVILEGES ON property_management_dev.* TO <span style="color:#e6db74">&#39;dev_user&#39;</span>@<span style="color:#e6db74">&#39;localhost&#39;</span>;
</span></span><span style="display:flex;"><span>FLUSH PRIVILEGES;
</span></span></code></pre></div><p><strong>Why Homebrew MySQL over Docker for development databases?</strong></p>
<ul>
<li>Native ARM64 performance without emulation overhead</li>
<li>Persistent storage naturally handled by macOS filesystem</li>
<li>Simpler connection strings for local development (<code>localhost:3306</code>)</li>
<li>Automatic startup with <code>brew services</code></li>
</ul>
<h2 id="containerized-services-setup">Containerized Services Setup</h2>
<h3 id="docker-desktop-configuration">Docker Desktop Configuration</h3>
<p>Docker Desktop for Mac M4 requires specific configuration for optimal ARM64 support:</p>
<ol>
<li><strong>Settings → General</strong>: Enable &ldquo;Use Virtualization framework&rdquo;</li>
<li><strong>Settings → Resources</strong>: Allocate 8GB RAM, 4 CPUs for container workloads</li>
<li><strong>Settings → Docker Engine</strong>: Add experimental features if needed</li>
</ol>
<h3 id="n8n-workflow-automation">n8n Workflow Automation</h3>
<p>n8n serves as the productivity automation hub, handling scheduled tasks, API integrations, and workflow orchestration.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># docker-compose.yml for n8n</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#39;3.8&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">n8n</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">n8nio/n8n:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">n8n</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">unless-stopped</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;5678:5678&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">N8N_BASIC_AUTH_ACTIVE=true</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">N8N_BASIC_AUTH_USER=admin</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">N8N_BASIC_AUTH_PASSWORD=${N8N_PASSWORD}</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">N8N_HOST=${N8N_HOST}</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">N8N_PROTOCOL=https</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">WEBHOOK_URL=https://${N8N_HOST}/</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">GENERIC_TIMEZONE=Asia/Taipei</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">n8n_data:/home/node/.n8n</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">./workflows:/workflows</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">n8n_data</span>:
</span></span></code></pre></div><p><strong>Deployment considerations:</strong></p>
<ul>
<li>Store <code>N8N_PASSWORD</code> in <code>.env</code> file (add to <code>.gitignore</code>)</li>
<li>Use Tailscale MagicDNS for <code>N8N_HOST</code> if accessing remotely</li>
<li>Mount <code>/workflows</code> directory for version-controlled workflow backups</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Start n8n</span>
</span></span><span style="display:flex;"><span>docker-compose up -d n8n
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># View logs</span>
</span></span><span style="display:flex;"><span>docker-compose logs -f n8n
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Access at http://localhost:5678 (local) or https://mac-mini.tailnet-name.ts.net:5678 (remote)</span>
</span></span></code></pre></div><h2 id="go-development-environment">Go Development Environment</h2>
<h3 id="project-structure-setup">Project Structure Setup</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Create workspace directory</span>
</span></span><span style="display:flex;"><span>mkdir -p ~/workspace/go-projects
</span></span><span style="display:flex;"><span>cd ~/workspace/go-projects
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Clone property management project</span>
</span></span><span style="display:flex;"><span>git clone git@github.com:username/property-management-system.git
</span></span><span style="display:flex;"><span>cd property-management-system
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Install Go dependencies</span>
</span></span><span style="display:flex;"><span>go mod download
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Verify Go toolchain</span>
</span></span><span style="display:flex;"><span>go version  <span style="color:#75715e"># Should show go1.21+ for ARM64</span>
</span></span></code></pre></div><p>Remote SSH connection from external machine:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># From laptop</span>
</span></span><span style="display:flex;"><span>ssh -i ~/.ssh/id_ed25519 username@mac-mini.tailnet-name.ts.net
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Or via VS Code Remote SSH extension</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Remote-SSH: Connect to Host... → mac-mini.tailnet-name.ts.net</span>
</span></span></code></pre></div><h2 id="productivity-automation-with-n8n">Productivity Automation with n8n</h2>
<h3 id="common-workflow-examples">Common Workflow Examples</h3>
<p><strong>1. Database Backup Automation</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">// n8n workflow: Daily MySQL backup
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Trigger: Cron (daily 2 AM)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// → Execute Command: mysqldump
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// → Upload to Cloud Storage (optional)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Execute Command node
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">command</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`mysqldump -u dev_user -p&#39;</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">$env</span>.<span style="color:#a6e22e">DB_PASSWORD</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#39; property_management_dev &gt; /backup/db_$(date +%Y%m%d).sql`</span>;
</span></span></code></pre></div><p><strong>2. Git Commit Reminder</strong></p>
<ul>
<li><strong>Trigger</strong>: Cron (every workday 6 PM)</li>
<li><strong>Check</strong>: Query Git for uncommitted changes</li>
<li><strong>Notify</strong>: Send Telegram/Slack message if dirty workspace detected</li>
</ul>
<p><strong>3. Development Metrics Collection</strong></p>
<ul>
<li><strong>Trigger</strong>: Webhook from CI/CD pipeline</li>
<li><strong>Process</strong>: Extract test coverage, build time</li>
<li><strong>Store</strong>: Append to Google Sheets or local CSV</li>
</ul>
<h2 id="system-maintenance-considerations">System Maintenance Considerations</h2>
<h3 id="automatic-updates-management">Automatic Updates Management</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Disable automatic macOS updates for stability</span>
</span></span><span style="display:flex;"><span>sudo defaults write /Library/Preferences/com.apple.SoftwareUpdate AutomaticCheckEnabled -bool false
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Manually check when ready</span>
</span></span><span style="display:flex;"><span>softwareupdate --list
</span></span><span style="display:flex;"><span>softwareupdate --install --all
</span></span></code></pre></div><h3 id="monitoring-and-logging">Monitoring and Logging</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># System resource monitoring</span>
</span></span><span style="display:flex;"><span>htop
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Docker container stats</span>
</span></span><span style="display:flex;"><span>docker stats
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># n8n execution logs</span>
</span></span><span style="display:flex;"><span>docker-compose logs -f n8n --tail<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># MySQL slow query log</span>
</span></span><span style="display:flex;"><span>mysql -u root -p -e <span style="color:#e6db74">&#34;SET GLOBAL slow_query_log = &#39;ON&#39;;&#34;</span>
</span></span><span style="display:flex;"><span>mysql -u root -p -e <span style="color:#e6db74">&#34;SET GLOBAL long_query_time = 2;&#34;</span>
</span></span><span style="display:flex;"><span>tail -f /usr/local/var/mysql/<span style="color:#66d9ef">$(</span>hostname<span style="color:#66d9ef">)</span>-slow.log
</span></span></code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>Today mainly setting up the remote development environment , mainly focusing on the database and containerized services.Also setting up the ssh connection between the mac mini and the laptop. Hopefully this will decrease the difficulty of remaining the difference between the mac mini and the laptop.</p>
]]></content></item><item><title>Simplifying User Permission Management: A Practical Database Design Approach</title><link>https://ifan0927.github.io/my-tech-blog/posts/2025_11_19_note/</link><pubDate>Thu, 20 Nov 2025 00:27:38 +0800</pubDate><guid>https://ifan0927.github.io/my-tech-blog/posts/2025_11_19_note/</guid><description>&lt;h2 id="introduction"&gt;Introduction&lt;/h2&gt;
&lt;p&gt;When building a property management system, one of the first architectural decisions involves user permission management. While it&amp;rsquo;s tempting to implement Role-Based Access Control (RBAC) with its elaborate role hierarchies and permission matrices, sometimes a simpler approach proves more effective. This article explores how I designed a straightforward yet flexible permission system using MySQL and golang-migrate CLI, focusing on pragmatic solutions over theoretical completeness.&lt;/p&gt;
&lt;h2 id="the-permission-design-philosophy"&gt;The Permission Design Philosophy&lt;/h2&gt;
&lt;h3 id="why-group-based-over-role-based"&gt;Why Group-Based Over Role-Based?&lt;/h3&gt;
&lt;p&gt;In early-stage applications, especially side projects or MVPs, over-engineered permission systems often create more problems than they solve:&lt;/p&gt;</description><content type="html"><![CDATA[<h2 id="introduction">Introduction</h2>
<p>When building a property management system, one of the first architectural decisions involves user permission management. While it&rsquo;s tempting to implement Role-Based Access Control (RBAC) with its elaborate role hierarchies and permission matrices, sometimes a simpler approach proves more effective. This article explores how I designed a straightforward yet flexible permission system using MySQL and golang-migrate CLI, focusing on pragmatic solutions over theoretical completeness.</p>
<h2 id="the-permission-design-philosophy">The Permission Design Philosophy</h2>
<h3 id="why-group-based-over-role-based">Why Group-Based Over Role-Based?</h3>
<p>In early-stage applications, especially side projects or MVPs, over-engineered permission systems often create more problems than they solve:</p>
<ul>
<li><strong>Maintenance Burden</strong>: Complex RBAC systems require constant updates as business logic evolves</li>
<li><strong>Query Overhead</strong>: Multi-table joins for permission checks can impact performance</li>
<li><strong>Development Friction</strong>: Team members spend more time configuring roles than building features</li>
</ul>
<p>Instead, I opted for a <strong>group-based permission model</strong> where permissions attach to user groups, and users inherit permissions through their group membership. This approach provides a middle ground between individual user permissions and complex role hierarchies.</p>
<h3 id="core-design-decisions">Core Design Decisions</h3>
<p>The permission system centers around three key entities:</p>
<ol>
<li><strong>User Groups</strong>: Organizational permission containers (admin, boss, manager, employee, intern)</li>
<li><strong>Users</strong>: Account holders assigned to specific groups</li>
<li><strong>Group Permissions</strong>: HTTP method + path combinations assigned to groups</li>
</ol>
<p>Here&rsquo;s the essential structure:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> user_groups (
</span></span><span style="display:flex;"><span>    id INT <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> AUTO_INCREMENT,
</span></span><span style="display:flex;"><span>    name VARCHAR(<span style="color:#ae81ff">50</span>) <span style="color:#66d9ef">UNIQUE</span> <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,  <span style="color:#75715e">-- admin, boss, manager, employee, intern
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    display_name VARCHAR(<span style="color:#ae81ff">100</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>, <span style="color:#75715e">-- 系統管理員, 老闆, 主管...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    description TEXT,
</span></span><span style="display:flex;"><span>    created_at <span style="color:#66d9ef">TIMESTAMP</span> <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">CURRENT_TIMESTAMP</span>
</span></span><span style="display:flex;"><span>) ENGINE<span style="color:#f92672">=</span>InnoDB <span style="color:#66d9ef">DEFAULT</span> CHARSET<span style="color:#f92672">=</span>utf8mb4 <span style="color:#66d9ef">COLLATE</span><span style="color:#f92672">=</span>utf8mb4_unicode_ci;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> users (
</span></span><span style="display:flex;"><span>    id INT <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> AUTO_INCREMENT,
</span></span><span style="display:flex;"><span>    email VARCHAR(<span style="color:#ae81ff">100</span>) <span style="color:#66d9ef">UNIQUE</span> <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
</span></span><span style="display:flex;"><span>    password_hash VARCHAR(<span style="color:#ae81ff">255</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
</span></span><span style="display:flex;"><span>    display_name VARCHAR(<span style="color:#ae81ff">100</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
</span></span><span style="display:flex;"><span>    is_active BOOLEAN <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">TRUE</span>,
</span></span><span style="display:flex;"><span>    group_id INT <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    last_login <span style="color:#66d9ef">TIMESTAMP</span> <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
</span></span><span style="display:flex;"><span>    created_at <span style="color:#66d9ef">TIMESTAMP</span> <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">CURRENT_TIMESTAMP</span>,
</span></span><span style="display:flex;"><span>    updated_at <span style="color:#66d9ef">TIMESTAMP</span> <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">CURRENT_TIMESTAMP</span> <span style="color:#66d9ef">ON</span> <span style="color:#66d9ef">UPDATE</span> <span style="color:#66d9ef">CURRENT_TIMESTAMP</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">FOREIGN</span> <span style="color:#66d9ef">KEY</span> (group_id) <span style="color:#66d9ef">REFERENCES</span> user_groups(id)
</span></span><span style="display:flex;"><span>) ENGINE<span style="color:#f92672">=</span>InnoDB <span style="color:#66d9ef">DEFAULT</span> CHARSET<span style="color:#f92672">=</span>utf8mb4;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> group_permissions (
</span></span><span style="display:flex;"><span>    id INT <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> AUTO_INCREMENT,
</span></span><span style="display:flex;"><span>    user_group_id INT <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">method</span> ENUM(<span style="color:#e6db74">&#39;GET&#39;</span>, <span style="color:#e6db74">&#39;POST&#39;</span>, <span style="color:#e6db74">&#39;PUT&#39;</span>, <span style="color:#e6db74">&#39;DELETE&#39;</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
</span></span><span style="display:flex;"><span>    path VARCHAR(<span style="color:#ae81ff">200</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,  <span style="color:#75715e">-- /api/estates, /api/estates/:id
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    created_at <span style="color:#66d9ef">TIMESTAMP</span> <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">CURRENT_TIMESTAMP</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">FOREIGN</span> <span style="color:#66d9ef">KEY</span> (user_group_id) <span style="color:#66d9ef">REFERENCES</span> user_groups(id) <span style="color:#66d9ef">ON</span> <span style="color:#66d9ef">DELETE</span> <span style="color:#66d9ef">CASCADE</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">UNIQUE</span> <span style="color:#66d9ef">KEY</span> uk_group_method_path (user_group_id, <span style="color:#66d9ef">method</span>, path)
</span></span><span style="display:flex;"><span>) ENGINE<span style="color:#f92672">=</span>InnoDB <span style="color:#66d9ef">DEFAULT</span> CHARSET<span style="color:#f92672">=</span>utf8mb4;
</span></span></code></pre></div><p>The beauty lies in the <strong>API-first permission design</strong>—permissions are defined as HTTP method + path combinations, mapping directly to RESTful endpoints.</p>
<h2 id="implementing-database-migrations-with-golang-migrate-cli">Implementing Database Migrations with golang-migrate CLI</h2>
<h3 id="why-golang-migrate-cli">Why golang-migrate CLI?</h3>
<p>Unlike ORM-based migrations, golang-migrate CLI provides:</p>
<ul>
<li><strong>Database Agnostic</strong>: Works with MySQL, PostgreSQL, SQLite, etc.</li>
<li><strong>Version Control</strong>: Clear up/down migration pairs</li>
<li><strong>Production Safety</strong>: Explicit control over schema changes</li>
<li><strong>CI/CD Integration</strong>: Easy to integrate into deployment pipelines</li>
</ul>
<h3 id="setting-up-migrations">Setting Up Migrations</h3>
<p>First, install golang-migrate:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># macOS</span>
</span></span><span style="display:flex;"><span>brew install golang-migrate
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Linux</span>
</span></span><span style="display:flex;"><span>curl -L https://github.com/golang-migrate/migrate/releases/download/v4.17.0/migrate.linux-amd64.tar.gz | tar xvz
</span></span><span style="display:flex;"><span>sudo mv migrate /usr/local/bin/
</span></span></code></pre></div><p>Create a migrations directory structure:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir -p migrations
</span></span><span style="display:flex;"><span>cd migrations
</span></span></code></pre></div><h3 id="creating-the-migration-file">Creating the Migration File</h3>
<p>Generate a new migration:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>migrate create -ext sql -dir . -seq adding_user_groups_permissions
</span></span></code></pre></div><p>This creates two files:</p>
<ul>
<li><code>000003_adding_user_groups_permissions.up.sql</code> (schema changes)</li>
<li><code>000003_adding_user_groups_permissions.down.sql</code> (rollback)</li>
</ul>
<p>The <code>up</code> migration contains our complete schema as shown above. The naming convention <code>000003_</code> ensures proper execution order.</p>
<h3 id="running-migrations">Running Migrations</h3>
<p>Execute migrations against your MySQL database:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Run all pending migrations</span>
</span></span><span style="display:flex;"><span>migrate -path ./migrations <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        -database <span style="color:#e6db74">&#34;mysql://user:password@tcp(localhost:3306)/property_db&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        up
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Run specific number of migrations</span>
</span></span><span style="display:flex;"><span>migrate -path ./migrations <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        -database <span style="color:#e6db74">&#34;mysql://user:password@tcp(localhost:3306)/property_db&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        up <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Check current version</span>
</span></span><span style="display:flex;"><span>migrate -path ./migrations <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        -database <span style="color:#e6db74">&#34;mysql://user:password@tcp(localhost:3306)/property_db&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        version
</span></span></code></pre></div><h3 id="rollback-strategy">Rollback Strategy</h3>
<p>If something goes wrong, rollback is straightforward:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Rollback last migration</span>
</span></span><span style="display:flex;"><span>migrate -path ./migrations <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        -database <span style="color:#e6db74">&#34;mysql://user:password@tcp(localhost:3306)/property_db&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        down <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Rollback all migrations</span>
</span></span><span style="display:flex;"><span>migrate -path ./migrations <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        -database <span style="color:#e6db74">&#34;mysql://user:password@tcp(localhost:3306)/property_db&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        down
</span></span></code></pre></div><h2 id="data-migration-seeding-initial-groups-and-users">Data Migration: Seeding Initial Groups and Users</h2>
<h3 id="the-python-migration-script">The Python Migration Script</h3>
<p>After schema creation, I needed to seed initial data and migrate existing users. Here&rsquo;s the Python script I used:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> pymysql
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> bcrypt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Database connection</span>
</span></span><span style="display:flex;"><span>conn <span style="color:#f92672">=</span> pymysql<span style="color:#f92672">.</span>connect(
</span></span><span style="display:flex;"><span>    host<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;localhost&#39;</span>,
</span></span><span style="display:flex;"><span>    user<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;root&#39;</span>,
</span></span><span style="display:flex;"><span>    password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;your_password&#39;</span>,
</span></span><span style="display:flex;"><span>    database<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;property_db&#39;</span>,
</span></span><span style="display:flex;"><span>    charset<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;utf8mb4&#39;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>cursor <span style="color:#f92672">=</span> conn<span style="color:#f92672">.</span>cursor()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Step 1: Insert default user groups</span>
</span></span><span style="display:flex;"><span>user_groups <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    (<span style="color:#e6db74">&#39;admin&#39;</span>, <span style="color:#e6db74">&#39;系統管理員&#39;</span>, <span style="color:#e6db74">&#39;擁有所有系統權限&#39;</span>),
</span></span><span style="display:flex;"><span>    (<span style="color:#e6db74">&#39;boss&#39;</span>, <span style="color:#e6db74">&#39;老闆&#39;</span>, <span style="color:#e6db74">&#39;查看所有資料與報表&#39;</span>),
</span></span><span style="display:flex;"><span>    (<span style="color:#e6db74">&#39;manager&#39;</span>, <span style="color:#e6db74">&#39;主管&#39;</span>, <span style="color:#e6db74">&#39;管理物業與房間&#39;</span>),
</span></span><span style="display:flex;"><span>    (<span style="color:#e6db74">&#39;employee&#39;</span>, <span style="color:#e6db74">&#39;員工&#39;</span>, <span style="color:#e6db74">&#39;處理日常業務&#39;</span>),
</span></span><span style="display:flex;"><span>    (<span style="color:#e6db74">&#39;intern&#39;</span>, <span style="color:#e6db74">&#39;實習生&#39;</span>, <span style="color:#e6db74">&#39;有限的查看權限&#39;</span>)
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> name, display_name, description <span style="color:#f92672">in</span> user_groups:
</span></span><span style="display:flex;"><span>    cursor<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        INSERT INTO user_groups (name, display_name, description)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        VALUES (</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">, </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">, </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ON DUPLICATE KEY UPDATE display_name=VALUES(display_name)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>, (name, display_name, description))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>conn<span style="color:#f92672">.</span>commit()
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;✓ User groups seeded successfully&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Step 2: Get group IDs for reference</span>
</span></span><span style="display:flex;"><span>cursor<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;SELECT id, name FROM user_groups&#34;</span>)
</span></span><span style="display:flex;"><span>groups <span style="color:#f92672">=</span> {name: id <span style="color:#66d9ef">for</span> id, name <span style="color:#f92672">in</span> cursor<span style="color:#f92672">.</span>fetchall()}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Step 3: Migrate existing users from old system</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Assuming we have old user data to migrate</span>
</span></span><span style="display:flex;"><span>old_users <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#39;email&#39;</span>: <span style="color:#e6db74">&#39;admin@company.com&#39;</span>, <span style="color:#e6db74">&#39;display_name&#39;</span>: <span style="color:#e6db74">&#39;系統管理員&#39;</span>, <span style="color:#e6db74">&#39;group&#39;</span>: <span style="color:#e6db74">&#39;admin&#39;</span>},
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#39;email&#39;</span>: <span style="color:#e6db74">&#39;boss@company.com&#39;</span>, <span style="color:#e6db74">&#39;display_name&#39;</span>: <span style="color:#e6db74">&#39;王老闆&#39;</span>, <span style="color:#e6db74">&#39;group&#39;</span>: <span style="color:#e6db74">&#39;boss&#39;</span>},
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#39;email&#39;</span>: <span style="color:#e6db74">&#39;manager1@company.com&#39;</span>, <span style="color:#e6db74">&#39;display_name&#39;</span>: <span style="color:#e6db74">&#39;李主管&#39;</span>, <span style="color:#e6db74">&#39;group&#39;</span>: <span style="color:#e6db74">&#39;manager&#39;</span>},
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> user <span style="color:#f92672">in</span> old_users:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Generate default password (should be changed on first login)</span>
</span></span><span style="display:flex;"><span>    default_password <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ChangeMe123!&#39;</span>
</span></span><span style="display:flex;"><span>    password_hash <span style="color:#f92672">=</span> bcrypt<span style="color:#f92672">.</span>hashpw(default_password<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;utf-8&#39;</span>), bcrypt<span style="color:#f92672">.</span>gensalt())
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    cursor<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        INSERT INTO users (email, password_hash, display_name, group_id, is_active)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        VALUES (</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">, </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">, </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">, </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">, TRUE)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ON DUPLICATE KEY UPDATE 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            display_name=VALUES(display_name),
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            group_id=VALUES(group_id)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>, (user[<span style="color:#e6db74">&#39;email&#39;</span>], password_hash<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>), user[<span style="color:#e6db74">&#39;display_name&#39;</span>], groups[user[<span style="color:#e6db74">&#39;group&#39;</span>]]))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>conn<span style="color:#f92672">.</span>commit()
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;✓ Migrated </span><span style="color:#e6db74">{</span>len(old_users)<span style="color:#e6db74">}</span><span style="color:#e6db74"> users successfully&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Step 4: Seed default permissions for admin group</span>
</span></span><span style="display:flex;"><span>admin_permissions <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    (<span style="color:#e6db74">&#39;GET&#39;</span>, <span style="color:#e6db74">&#39;/api/estates&#39;</span>),
</span></span><span style="display:flex;"><span>    (<span style="color:#e6db74">&#39;POST&#39;</span>, <span style="color:#e6db74">&#39;/api/estates&#39;</span>),
</span></span><span style="display:flex;"><span>    (<span style="color:#e6db74">&#39;PUT&#39;</span>, <span style="color:#e6db74">&#39;/api/estates/:id&#39;</span>),
</span></span><span style="display:flex;"><span>    (<span style="color:#e6db74">&#39;DELETE&#39;</span>, <span style="color:#e6db74">&#39;/api/estates/:id&#39;</span>),
</span></span><span style="display:flex;"><span>    (<span style="color:#e6db74">&#39;GET&#39;</span>, <span style="color:#e6db74">&#39;/api/rooms&#39;</span>),
</span></span><span style="display:flex;"><span>    (<span style="color:#e6db74">&#39;POST&#39;</span>, <span style="color:#e6db74">&#39;/api/rooms&#39;</span>),
</span></span><span style="display:flex;"><span>    (<span style="color:#e6db74">&#39;PUT&#39;</span>, <span style="color:#e6db74">&#39;/api/rooms/:id&#39;</span>),
</span></span><span style="display:flex;"><span>    (<span style="color:#e6db74">&#39;DELETE&#39;</span>, <span style="color:#e6db74">&#39;/api/rooms/:id&#39;</span>),
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>admin_group_id <span style="color:#f92672">=</span> groups[<span style="color:#e6db74">&#39;admin&#39;</span>]
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> method, path <span style="color:#f92672">in</span> admin_permissions:
</span></span><span style="display:flex;"><span>    cursor<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        INSERT INTO group_permissions (user_group_id, method, path)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        VALUES (</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">, </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">, </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ON DUPLICATE KEY UPDATE method=VALUES(method)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>, (admin_group_id, method, path))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>conn<span style="color:#f92672">.</span>commit()
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;✓ Seeded </span><span style="color:#e6db74">{</span>len(admin_permissions)<span style="color:#e6db74">}</span><span style="color:#e6db74"> permissions for admin group&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cursor<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>conn<span style="color:#f92672">.</span>close()
</span></span></code></pre></div><h3 id="key-migration-patterns">Key Migration Patterns</h3>
<p><strong>1. Idempotent Inserts</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>INSERT INTO user_groups (name, display_name, description)
</span></span><span style="display:flex;"><span>VALUES (<span style="color:#f92672">%</span>s, <span style="color:#f92672">%</span>s, <span style="color:#f92672">%</span>s)
</span></span><span style="display:flex;"><span>ON DUPLICATE KEY UPDATE display_name<span style="color:#f92672">=</span>VALUES(display_name)
</span></span></code></pre></div><p>This pattern ensures the script can run multiple times safely without creating duplicates.</p>
<p><strong>2. Password Hashing</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>password_hash <span style="color:#f92672">=</span> bcrypt<span style="color:#f92672">.</span>hashpw(default_password<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;utf-8&#39;</span>), bcrypt<span style="color:#f92672">.</span>gensalt())
</span></span></code></pre></div><p>Always hash passwords before storage. bcrypt is industry-standard for password hashing with built-in salt generation.</p>
<p><strong>3. Group ID Mapping</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>cursor<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;SELECT id, name FROM user_groups&#34;</span>)
</span></span><span style="display:flex;"><span>groups <span style="color:#f92672">=</span> {name: id <span style="color:#66d9ef">for</span> id, name <span style="color:#f92672">in</span> cursor<span style="color:#f92672">.</span>fetchall()}
</span></span></code></pre></div><p>Creating a dictionary mapping makes it easy to reference group IDs when inserting users.</p>
<h2 id="why-this-design-works">Why This Design Works</h2>
<h3 id="api-first-permission-model">API-First Permission Model</h3>
<p>The <code>group_permissions</code> table directly maps to API endpoints:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">method</span> ENUM(<span style="color:#e6db74">&#39;GET&#39;</span>, <span style="color:#e6db74">&#39;POST&#39;</span>, <span style="color:#e6db74">&#39;PUT&#39;</span>, <span style="color:#e6db74">&#39;DELETE&#39;</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
</span></span><span style="display:flex;"><span>path VARCHAR(<span style="color:#ae81ff">200</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>  <span style="color:#75715e">-- /api/estates, /api/estates/:id
</span></span></span></code></pre></div><p>This design enables <strong>middleware-based permission checks</strong> in your application:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Pseudo-code for permission middleware</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">CheckPermission</span>(<span style="color:#a6e22e">method</span>, <span style="color:#a6e22e">path</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">userGroupID</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">count</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">QueryRow</span>(<span style="color:#e6db74">`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        SELECT COUNT(*) FROM group_permissions 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        WHERE user_group_id = ? AND method = ? AND path = ?
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    `</span>, <span style="color:#a6e22e">userGroupID</span>, <span style="color:#a6e22e">method</span>, <span style="color:#a6e22e">path</span>).<span style="color:#a6e22e">Scan</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">count</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">count</span> &gt; <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="performance-advantages">Performance Advantages</h3>
<p>This design offers several performance benefits:</p>
<ol>
<li><strong>Single Join for Permission Checks</strong>: Verifying permissions requires joining only two tables (users → group_permissions)</li>
<li><strong>Unique Constraint Optimization</strong>: <code>UNIQUE KEY uk_group_method_path</code> prevents duplicate permissions and creates an automatic index</li>
<li><strong>Enum for HTTP Methods</strong>: Using ENUM instead of VARCHAR saves storage and improves query performance</li>
</ol>
<h3 id="database-level-integrity">Database-Level Integrity</h3>
<p>Critical constraints enforced at the database level:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">FOREIGN</span> <span style="color:#66d9ef">KEY</span> (group_id) <span style="color:#66d9ef">REFERENCES</span> user_groups(id)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FOREIGN</span> <span style="color:#66d9ef">KEY</span> (user_group_id) <span style="color:#66d9ef">REFERENCES</span> user_groups(id) <span style="color:#66d9ef">ON</span> <span style="color:#66d9ef">DELETE</span> <span style="color:#66d9ef">CASCADE</span>
</span></span></code></pre></div><p><strong>CASCADE deletion</strong> ensures when a group is deleted, all associated permissions are automatically removed, preventing orphaned records.</p>
<h2 id="golang-migrate-best-practices">golang-migrate Best Practices</h2>
<h3 id="migration-file-naming-convention">Migration File Naming Convention</h3>
<pre tabindex="0"><code>000001_create_estates_table.up.sql
000002_create_rooms_table.up.sql
000003_adding_user_groups_permissions.up.sql
</code></pre><p>Sequential numbering ensures proper execution order, which is critical when tables have foreign key dependencies.</p>
<h3 id="always-create-paired-migrations">Always Create Paired Migrations</h3>
<p>Every <code>up</code> migration should have a corresponding <code>down</code> migration:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">-- 000003_adding_user_groups_permissions.down.sql
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">DROP</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#66d9ef">IF</span> <span style="color:#66d9ef">EXISTS</span> group_permissions;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">DROP</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#66d9ef">IF</span> <span style="color:#66d9ef">EXISTS</span> users;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">DROP</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#66d9ef">IF</span> <span style="color:#66d9ef">EXISTS</span> user_groups;
</span></span></code></pre></div><p>Note the <strong>reverse order</strong> when dropping tables to respect foreign key constraints.</p>
<h3 id="version-control-integration">Version Control Integration</h3>
<p>Add migrations to git:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git add migrations/
</span></span><span style="display:flex;"><span>git commit -m <span style="color:#e6db74">&#34;feat: add user groups and permissions schema&#34;</span>
</span></span></code></pre></div><p>This provides a complete history of schema evolution.</p>
<h2 id="conclusion">Conclusion</h2>
<p>This permission system demonstrates that effective software design often favors simplicity over complexity. By focusing on group-based permissions tied directly to API endpoints, and leveraging golang-migrate CLI for version-controlled schema management, we achieve a maintainable solution without sacrificing functionality.</p>
<p>The combination of SQL migrations for schema control and Python scripts for data seeding provides clear separation between structure and content, making the system easier to understand and maintain.</p>
]]></content></item><item><title>DTOs data mapping and Router in Go gin framework</title><link>https://ifan0927.github.io/my-tech-blog/posts/2025_11_18_note/</link><pubDate>Wed, 19 Nov 2025 00:06:34 +0800</pubDate><guid>https://ifan0927.github.io/my-tech-blog/posts/2025_11_18_note/</guid><description>&lt;h2 id="introduction"&gt;Introduction&lt;/h2&gt;
&lt;p&gt;When building REST APIs with Go and Gin framework, two fundamental challenges often emerge: handling data transfer between layers with different nullability requirements, and extracting parameters from HTTP requests. This post walks through practical solutions for DTO mapping with pointer types and demonstrates various parameter extraction patterns in Gin routers.&lt;/p&gt;
&lt;h2 id="understanding-pointer-semantics-in-dto-mapping"&gt;Understanding Pointer Semantics in DTO Mapping&lt;/h2&gt;
&lt;h3 id="the-core-challenge"&gt;The Core Challenge&lt;/h3&gt;
&lt;p&gt;When mapping between domain models and DTOs, mismatched pointer types create compilation errors. Consider this common scenario:&lt;/p&gt;</description><content type="html"><![CDATA[<h2 id="introduction">Introduction</h2>
<p>When building REST APIs with Go and Gin framework, two fundamental challenges often emerge: handling data transfer between layers with different nullability requirements, and extracting parameters from HTTP requests. This post walks through practical solutions for DTO mapping with pointer types and demonstrates various parameter extraction patterns in Gin routers.</p>
<h2 id="understanding-pointer-semantics-in-dto-mapping">Understanding Pointer Semantics in DTO Mapping</h2>
<h3 id="the-core-challenge">The Core Challenge</h3>
<p>When mapping between domain models and DTOs, mismatched pointer types create compilation errors. Consider this common scenario:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Domain Model (Source)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Tenant</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Name</span>  <span style="color:#66d9ef">string</span>   <span style="color:#75715e">// Non-pointer</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Phone</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">string</span>  <span style="color:#75715e">// Pointer (nullable)</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// DTO (Target)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">TenantDto</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Name</span>  <span style="color:#f92672">*</span><span style="color:#66d9ef">string</span>  <span style="color:#75715e">// Pointer (nullable in API)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Phone</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">string</span>  <span style="color:#75715e">// Pointer (nullable in API)</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="three-mapping-scenarios">Three Mapping Scenarios</h3>
<p><strong>Scenario 1: Non-pointer to Pointer</strong></p>
<p>When the source field is a concrete value but the DTO expects a pointer:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// ❌ Direct assignment fails</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">dto</span>.<span style="color:#a6e22e">Name</span> = <span style="color:#a6e22e">tenant</span>.<span style="color:#a6e22e">Name</span>  <span style="color:#75715e">// Type mismatch</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ✅ Take the address</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">dto</span>.<span style="color:#a6e22e">Name</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">tenant</span>.<span style="color:#a6e22e">Name</span>
</span></span></code></pre></div><p><strong>Scenario 2: Pointer to Pointer</strong></p>
<p>When both types use pointers, direct assignment works:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// ✅ Direct assignment succeeds</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">dto</span>.<span style="color:#a6e22e">Phone</span> = <span style="color:#a6e22e">tenant</span>.<span style="color:#a6e22e">Phone</span>
</span></span></code></pre></div><p><strong>Scenario 3: Pointer to Non-pointer</strong></p>
<p>When the source is nullable but the target isn&rsquo;t, dereference with nil-checking:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// ❌ Direct dereference fails</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">dto</span>.<span style="color:#a6e22e">Phone</span> = <span style="color:#a6e22e">tenant</span>.<span style="color:#a6e22e">Phone</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ✅ Safely dereference</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tenant</span>.<span style="color:#a6e22e">Phone</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">dto</span>.<span style="color:#a6e22e">Phone</span> = <span style="color:#f92672">*</span><span style="color:#a6e22e">tenant</span>.<span style="color:#a6e22e">Phone</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="why-this-matters">Why This Matters</h3>
<p>The pattern reveals an important principle: <strong>nullable fields (pointers) require explicit nil-handling</strong>. When converting from optional to required fields, you must decide how to handle absence (default value, error, or skip). When converting required to optional, taking the address is safe because the value always exists.</p>
<h2 id="extracting-parameters-in-gin-routers">Extracting Parameters in Gin Routers</h2>
<h3 id="path-parameters">Path Parameters</h3>
<p>For RESTful resource identifiers embedded in URLs:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Route definition</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rooms</span>.<span style="color:#a6e22e">GET</span>(<span style="color:#e6db74">&#34;/:id&#34;</span>, <span style="color:#a6e22e">roomHandler</span>.<span style="color:#a6e22e">GetRoomByID</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Handler implementation</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">h</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">RoomHandler</span>) <span style="color:#a6e22e">GetRoomByID</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">id</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Param</span>(<span style="color:#e6db74">&#34;id&#34;</span>)  <span style="color:#75715e">// Extract path parameter</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// id contains &#34;123&#34; from GET /api/property/rooms/123</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="query-parameters">Query Parameters</h3>
<p>For optional filters and modifiers:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">h</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">RoomHandler</span>) <span style="color:#a6e22e">GetRoomByID</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">include</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Query</span>(<span style="color:#e6db74">&#34;include&#34;</span>)          <span style="color:#75715e">// Returns &#34;&#34; if not present</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sort</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">DefaultQuery</span>(<span style="color:#e6db74">&#34;sort&#34;</span>, <span style="color:#e6db74">&#34;name&#34;</span>) <span style="color:#75715e">// Returns &#34;name&#34; if not present</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// From GET /api/property/rooms/123?include=furniture&amp;sort=price</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="multiple-path-parameters">Multiple Path Parameters</h3>
<p>For nested resource hierarchies:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Route definition</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">estates</span>.<span style="color:#a6e22e">GET</span>(<span style="color:#e6db74">&#34;/:estateId/rooms/:roomId&#34;</span>, <span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">GetEstateRoom</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Handler implementation</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">h</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Handler</span>) <span style="color:#a6e22e">GetEstateRoom</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">estateID</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Param</span>(<span style="color:#e6db74">&#34;estateId&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">roomID</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Param</span>(<span style="color:#e6db74">&#34;roomId&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// From GET /api/property/estates/456/rooms/789</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="type-conversion">Type Conversion</h3>
<p>Path and query parameters arrive as strings. Use <code>strconv</code> for numeric conversions:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;strconv&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">id</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Param</span>(<span style="color:#e6db74">&#34;id&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">roomID</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Atoi</span>(<span style="color:#a6e22e">id</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusBadRequest</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#e6db74">&#34;Invalid room ID&#34;</span>})
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="error-handling-philosophy">Error Handling Philosophy</h2>
<p>Go&rsquo;s explicit error handling extends to HTTP handlers. Always anticipate failure points:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">h</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">RoomHandler</span>) <span style="color:#a6e22e">GetRoomByID</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 1. Extract and validate input</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">id</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Param</span>(<span style="color:#e6db74">&#34;id&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">roomID</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Atoi</span>(<span style="color:#a6e22e">id</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusBadRequest</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#e6db74">&#34;Invalid ID format&#34;</span>})
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 2. Perform business logic</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">room</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">GetRoom</span>(<span style="color:#a6e22e">roomID</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>()})
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 3. Return success</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">room</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This defensive approach prevents unexpected panics and provides clear error messages to API consumers.</p>
<h2 id="development-workflow-docker-vs-native">Development Workflow: Docker vs Native</h2>
<h3 id="hot-reload-with-air">Hot Reload with Air</h3>
<p>For containerized development, Air enables automatic recompilation:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#75715e"># Development Dockerfile</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span> <span style="color:#e6db74">golang:1.21</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span> <span style="color:#e6db74">/app</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> go install github.com/cosmtrek/air@latest<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> . .<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;air&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>However, maintaining separate Dockerfiles for development and production adds complexity. For simple projects, native Go development may be more straightforward—reserve Docker for production deployments and when you need environment parity.</p>
]]></content></item><item><title>2025_11_17_Note</title><link>https://ifan0927.github.io/my-tech-blog/posts/2025_11_17_note/</link><pubDate>Mon, 17 Nov 2025 23:40:50 +0800</pubDate><guid>https://ifan0927.github.io/my-tech-blog/posts/2025_11_17_note/</guid><description>&lt;h1 id="optimizing-database-queries-and-understanding-hash-maps-in-go"&gt;Optimizing Database Queries and Understanding Hash Maps in Go&lt;/h1&gt;
&lt;h2 id="introduction"&gt;Introduction&lt;/h2&gt;
&lt;p&gt;Today&amp;rsquo;s session tackled two common yet crucial challenges in backend development: eliminating the N+1 query problem in a room management API and understanding the proper time complexity approach for the classic Two Sum problem. Both scenarios revealed important lessons about thinking beyond the obvious solution and leveraging the right data structures for optimal performance.&lt;/p&gt;
&lt;h2 id="the-n1-query-problem-in-room-api"&gt;The N+1 Query Problem in Room API&lt;/h2&gt;
&lt;h3 id="identifying-the-anti-pattern"&gt;Identifying the Anti-Pattern&lt;/h3&gt;
&lt;p&gt;While building a room query page API that aggregates data from multiple models, I initially implemented what seemed like straightforward logic:&lt;/p&gt;</description><content type="html"><![CDATA[<h1 id="optimizing-database-queries-and-understanding-hash-maps-in-go">Optimizing Database Queries and Understanding Hash Maps in Go</h1>
<h2 id="introduction">Introduction</h2>
<p>Today&rsquo;s session tackled two common yet crucial challenges in backend development: eliminating the N+1 query problem in a room management API and understanding the proper time complexity approach for the classic Two Sum problem. Both scenarios revealed important lessons about thinking beyond the obvious solution and leveraging the right data structures for optimal performance.</p>
<h2 id="the-n1-query-problem-in-room-api">The N+1 Query Problem in Room API</h2>
<h3 id="identifying-the-anti-pattern">Identifying the Anti-Pattern</h3>
<p>While building a room query page API that aggregates data from multiple models, I initially implemented what seemed like straightforward logic:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Anti-pattern: N+1 Query</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 1. Fetch all rooms (1 query)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rooms</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">roomRepo</span>.<span style="color:#a6e22e">FindAll</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">room</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">rooms</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 2. For each room, fetch its lease (N queries)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">lease</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">leaseRepo</span>.<span style="color:#a6e22e">FindByRoomIdAndLeaseIsActive</span>(<span style="color:#a6e22e">room</span>.<span style="color:#a6e22e">ID</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 3. For each lease, fetch tenant (another N queries)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">tenant</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tenantRepo</span>.<span style="color:#a6e22e">FindByLeaseID</span>(<span style="color:#a6e22e">lease</span>.<span style="color:#a6e22e">ID</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This approach executes <code>1 + N + N</code> queries, where N is the number of rooms. For 100 rooms, that&rsquo;s potentially 201 database calls – a significant performance bottleneck.</p>
<h3 id="the-solution-eager-loading-with-preload">The Solution: Eager Loading with Preload</h3>
<p>GORM&rsquo;s <code>Preload</code> feature enables eager loading, fetching all related data in a minimal number of queries:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// FindAllWithDetails uses Preload for eager loading</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Includes active leases, tenants, and billing cycles</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">RoomRepository</span>) <span style="color:#a6e22e">FindAllWithDetails</span>() ([]<span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">Room</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rooms</span> []<span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">Room</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">db</span>.
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Preload</span>(<span style="color:#e6db74">&#34;Leases&#34;</span>, <span style="color:#e6db74">&#34;is_active = ?&#34;</span>, <span style="color:#66d9ef">true</span>).
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Preload</span>(<span style="color:#e6db74">&#34;Leases.LeaseTenant.Tenant&#34;</span>).
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Preload</span>(<span style="color:#e6db74">&#34;Leases.BillingCycle&#34;</span>).
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Find</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">rooms</span>).<span style="color:#a6e22e">Error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">rooms</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>Key Preload Patterns Learned:</strong></p>
<ul>
<li><strong>Basic Loading</strong>: <code>Preload(&quot;Leases&quot;)</code> loads all related leases</li>
<li><strong>Nested Loading</strong>: <code>Preload(&quot;Leases.LeaseTenant.Tenant&quot;)</code> traverses through relationships</li>
<li><strong>Conditional Loading</strong>: <code>Preload(&quot;Leases&quot;, &quot;is_active = ?&quot;, true)</code> applies filters</li>
</ul>
<h3 id="proper-model-associations">Proper Model Associations</h3>
<p>Critical to making Preload work is defining associations correctly in your models:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Room Model excerpt</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// GORM Preload Associations</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// These fields define what can be preloaded from the Room model</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// They don&#39;t create new database columns</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Leases represents all leases for a room</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// []Lease indicates a Room can have multiple Leases (Has Many relationship)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// gorm:&#34;foreignKey:RoomID&#34; tells GORM that the RoomID field in Lease</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// is the foreign key linking to this Room</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// When using db.Preload(&#34;Leases&#34;), GORM queries the Lease table</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// for all records where RoomID matches this Room&#39;s ID</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Leases</span> []<span style="color:#a6e22e">Lease</span> <span style="color:#e6db74">`gorm:&#34;foreignKey:RoomID&#34;`</span>
</span></span></code></pre></div><h2 id="leetcode-two-sum--beyond-the-obvious">LeetCode: Two Sum – Beyond the Obvious</h2>
<h3 id="the-false-two-pointer-solution">The False Two-Pointer Solution</h3>
<p>My initial approach to Two Sum used what I thought was a two-pointer technique, but it was actually a disguised brute force solution with O(n²) complexity:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Inefficient: Still O(n²)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; len(<span style="color:#a6e22e">nums</span>); <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">j</span> &lt; len(<span style="color:#a6e22e">nums</span>); <span style="color:#a6e22e">j</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">nums</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">+</span> <span style="color:#a6e22e">nums</span>[<span style="color:#a6e22e">j</span>] <span style="color:#f92672">==</span> <span style="color:#a6e22e">target</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> []<span style="color:#66d9ef">int</span>{<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">j</span>}
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="the-hash-map-approach">The Hash Map Approach</h3>
<p>The optimal solution leverages a hash map to achieve O(n) time complexity:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">twoSum</span>(<span style="color:#a6e22e">nums</span> []<span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">target</span> <span style="color:#66d9ef">int</span>) []<span style="color:#66d9ef">int</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int</span>]<span style="color:#66d9ef">int</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">num</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">nums</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">complement</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">target</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">num</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Check if complement exists and it&#39;s not the same element</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">j</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>[<span style="color:#a6e22e">complement</span>]; <span style="color:#a6e22e">ok</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">i</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> []<span style="color:#66d9ef">int</span>{<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">j</span>}
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">m</span>[<span style="color:#a6e22e">num</span>] = <span style="color:#a6e22e">i</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="go-map-syntax-deep-dive">Go Map Syntax Deep Dive</h3>
<p>This problem introduced several important Go map idioms:</p>
<p><strong>1. Two-Value Query:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">j</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>[<span style="color:#a6e22e">complement</span>]
</span></span></code></pre></div><ul>
<li><code>j</code>: the value (index) if key exists</li>
<li><code>ok</code>: boolean indicating key existence</li>
</ul>
<p><strong>2. Existence Check:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">ok</span>  <span style="color:#75715e">// true if complement exists in map</span>
</span></span></code></pre></div><p><strong>3. Element Uniqueness Validation:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">j</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">i</span>  <span style="color:#75715e">// ensures we don&#39;t use the same element twice</span>
</span></span></code></pre></div><p><strong>Combined in Conditional:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">j</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>[<span style="color:#a6e22e">complement</span>]; <span style="color:#a6e22e">ok</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">i</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> []<span style="color:#66d9ef">int</span>{<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">j</span>}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="key-takeaways">Key Takeaways</h2>
<p><strong>Database Performance:</strong></p>
<ul>
<li>Always be vigilant about N+1 queries when working with ORMs</li>
<li>GORM&rsquo;s Preload is powerful but requires proper model associations</li>
<li>Understand the difference between lazy and eager loading strategies</li>
</ul>
<p><strong>Algorithm Optimization:</strong></p>
<ul>
<li>Don&rsquo;t confuse similar-looking patterns (two-pointer vs. brute force)</li>
<li>Hash maps are often the key to reducing time complexity from O(n²) to O(n)</li>
<li>Go&rsquo;s multi-value return pattern (<code>value, ok := map[key]</code>) is idiomatic for safe map access</li>
</ul>
<hr>
<h2 id="conclusion">Conclusion</h2>
<ol>
<li>Finding N+1 queries problem by seeing the code is quite mess</li>
<li>Maybe Preload is the good way for some cases, but it might pulling out too much unnecessary info , so lazy loading might work sometime</li>
<li>Hashtable is the example of trading space for time</li>
</ol>
]]></content></item></channel></rss>