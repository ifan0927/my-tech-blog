<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="Today I focused on implementing the CreateLease business logic, which involves coordinating multiple database tables (Lease, LeaseTenant, Room, RentBill). This complexity made data consistency and atomicity critical considerations.
GORM Transaction Implementation with Repository Pattern When dealing with &ldquo;all-or-nothing&rdquo; business operations, proper transaction management is essential.
Core Concepts Repository Pattern with Transaction Integration: Our project follows a Handler -> Service -> Repository layered architecture. Since Repository instances are typically bound to global db connections, we adopted the WithTx pattern to enable Repository operations to participate in Service-layer transactions.
"><meta name=keywords content=",gorm,transaction,error-handling,go,backend"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://ifan0927.github.io/my-tech-blog/posts/2025-12-25_note/><title>GORM Transaction Management and Error Handling in Complex Business Logic :: I-Fan's Tech Blog</title><link rel=stylesheet href=/my-tech-blog/main.min.2729760c629597024c5de34b40ea9f372f2b5a2a192dcdca537b7ddfa483eab8.css integrity="sha256-Jyl2DGKVlwJMXeNLQOqfNy8rWioZLc3KU3t936SD6rg=" crossorigin=anonymous><link rel=apple-touch-icon sizes=180x180 href=/my-tech-blog/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/my-tech-blog/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/my-tech-blog/favicon-16x16.png><link rel=manifest href=/my-tech-blog/site.webmanifest><link rel=mask-icon href=/my-tech-blog/safari-pinned-tab.svg color><link rel="shortcut icon" href=/my-tech-blog/favicon.ico><meta name=msapplication-TileColor content><meta itemprop=name content="GORM Transaction Management and Error Handling in Complex Business Logic"><meta itemprop=description content="Today I focused on implementing the CreateLease business logic, which involves coordinating multiple database tables (Lease, LeaseTenant, Room, RentBill). This complexity made data consistency and atomicity critical considerations.
GORM Transaction Implementation with Repository Pattern When dealing with “all-or-nothing” business operations, proper transaction management is essential.
Core Concepts Repository Pattern with Transaction Integration: Our project follows a Handler -> Service -> Repository layered architecture. Since Repository instances are typically bound to global db connections, we adopted the WithTx pattern to enable Repository operations to participate in Service-layer transactions."><meta itemprop=datePublished content="2025-12-25T00:00:00+00:00"><meta itemprop=dateModified content="2025-12-25T00:00:00+00:00"><meta itemprop=wordCount content="549"><meta itemprop=keywords content="Gorm,Transaction,Error-Handling,Go,Backend"><meta name=twitter:card content="summary"><meta name=twitter:title content="GORM Transaction Management and Error Handling in Complex Business Logic"><meta name=twitter:description content="Today I focused on implementing the CreateLease business logic, which involves coordinating multiple database tables (Lease, LeaseTenant, Room, RentBill). This complexity made data consistency and atomicity critical considerations.
GORM Transaction Implementation with Repository Pattern When dealing with “all-or-nothing” business operations, proper transaction management is essential.
Core Concepts Repository Pattern with Transaction Integration: Our project follows a Handler -> Service -> Repository layered architecture. Since Repository instances are typically bound to global db connections, we adopted the WithTx pattern to enable Repository operations to participate in Service-layer transactions."><meta property="article:section" content="development"><meta property="article:section" content="database"><meta property="article:published_time" content="2025-12-25 00:00:00 +0000 UTC"></head><body><div class=container><header class=header><span class=header__inner><a href=/my-tech-blog style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>hello</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/my-tech-blog/about/>about</a></li><li><a href=/my-tech-blog/categories/>categories</a></li><li><a href=/my-tech-blog/posts/>posts</a></li><li><a href=/my-tech-blog/tags/>tags</a></li></ul></nav><span class=menu-trigger><svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
3分鐘</p></div><article><h1 class=post-title><a href=https://ifan0927.github.io/my-tech-blog/posts/2025-12-25_note/>GORM Transaction Management and Error Handling in Complex Business Logic</a></h1><div class=post-content><p>Today I focused on implementing the <code>CreateLease</code> business logic, which involves coordinating multiple database tables (Lease, LeaseTenant, Room, RentBill). This complexity made data consistency and atomicity critical considerations.</p><h2 id=gorm-transaction-implementation-with-repository-pattern>GORM Transaction Implementation with Repository Pattern</h2><p>When dealing with &ldquo;all-or-nothing&rdquo; business operations, proper transaction management is essential.</p><h3 id=core-concepts>Core Concepts</h3><p><strong>Repository Pattern with Transaction Integration</strong>: Our project follows a <code>Handler -> Service -> Repository</code> layered architecture. Since Repository instances are typically bound to global <code>db</code> connections, we adopted the <code>WithTx</code> pattern to enable Repository operations to participate in Service-layer transactions.</p><p><strong>Atomicity Guarantee</strong>: All write operations (Create, Update) and critical state checks (like <code>Room.IsAvailable</code>) are wrapped within <code>s.db.Transaction</code> closures.</p><h3 id=implementation-pattern>Implementation Pattern</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// 1. Start transaction at Service layer</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Transaction</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>tx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gorm</span>.<span style=color:#a6e22e>DB</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 2. Critical step: create temporary Repository instances bound to the transaction</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// All operations from these repos will execute within the same transaction</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>txRoomRepo</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>roomRepo</span>.<span style=color:#a6e22e>WithTx</span>(<span style=color:#a6e22e>tx</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>txLeaseRepo</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>leaseRepo</span>.<span style=color:#a6e22e>WithTx</span>(<span style=color:#a6e22e>tx</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 3. Execute business logic</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ... check room status ...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ... create lease ...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ... update room ...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span> <span style=color:#75715e>// return nil = Commit, return error = Rollback</span>
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><h3 id=key-design-decision-centralized-business-logic>Key Design Decision: Centralized Business Logic</h3><p><strong>Accepting Complexity</strong>: The <code>CreateLease</code> function contains the complete business flow, resulting in longer and more complex code. We confirmed this is <strong>acceptable</strong> because it represents a single, indivisible core business operation. Over-splitting would increase cognitive overhead and potentially break transaction integrity.</p><p><strong>Including Checks in Transaction</strong>: To prevent race conditions (e.g., two people renting the same room simultaneously), critical state checks like room availability must also be performed within the transaction.</p><h2 id=error-handling-and-logging-strategy>Error Handling and Logging Strategy</h2><p>Different error handling strategies apply inside and outside transaction boundaries.</p><h3 id=inside-transaction>Inside Transaction</h3><p><strong>Principle</strong>: Focus on flow control.
<strong>Action</strong>: Return errors directly to trigger GORM&rsquo;s automatic rollback.
<strong>Logging</strong>:</p><ul><li><strong>System Errors (DB Errors)</strong>: Usually <strong>don&rsquo;t</strong> log inside transactions; return errors for unified handling at outer layers.</li><li><strong>Business Warnings</strong>: For cases like &ldquo;room already rented,&rdquo; use <code>s.logger.Warn</code> to record business events for troubleshooting, then return the error.</li></ul><h3 id=outside-transaction-service-layer-boundary>Outside Transaction (Service Layer Boundary)</h3><p><strong>Principle</strong>: Unified error capture and recording.
<strong>Action</strong>: Catch errors returned from transactions.
<strong>Logging</strong>: Use <code>s.logger.Error</code> consistently to record failed operations with relevant context (like <code>roomID</code>, <code>request</code> data).
<strong>Return</strong>: Wrap errors (if needed) before returning to Handler layer.</p><h3 id=fmterrorf-vs-slogger-distinction>fmt.Errorf vs s.logger Distinction</h3><p><strong><code>s.logger</code> (Zap)</strong>: Used for <strong>recording</strong> structured logs for developers and operations teams, supporting log levels (Info, Warn, Error) for debugging and monitoring.
<strong><code>fmt.Errorf</code></strong>: Used for <strong>generating</strong> error objects for program logic (<code>errors.Is</code>) or returning to calling layers. Supports <code>%w</code> for error wrapping to preserve error chains.</p><h2 id=code-example-transaction-error-handling>Code Example: Transaction Error Handling</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>LeaseService</span>) <span style=color:#a6e22e>CreateLease</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>req</span> <span style=color:#a6e22e>CreateLeaseRequest</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Transaction</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>tx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gorm</span>.<span style=color:#a6e22e>DB</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>txRoomRepo</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>roomRepo</span>.<span style=color:#a6e22e>WithTx</span>(<span style=color:#a6e22e>tx</span>)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Business validation within transaction</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>room</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>txRoomRepo</span>.<span style=color:#a6e22e>GetByID</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>RoomID</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to get room: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>room</span>.<span style=color:#a6e22e>IsAvailable</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Warn</span>(<span style=color:#e6db74>&#34;attempt to rent unavailable room&#34;</span>, 
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;roomID&#34;</span>, <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>RoomID</span>))
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;room is not available&#34;</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Continue with lease creation...</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Unified error handling outside transaction</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#e6db74>&#34;failed to create lease&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;roomID&#34;</span>, <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>RoomID</span>),
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>err</span>))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;create lease failed: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=next-steps>Next Steps</h2><ul><li>Complete batch generation logic for <code>RentBill</code> (rental bills)</li><li>Write unit/integration tests for <code>CreateLease</code> to verify transaction rollback mechanisms</li><li>Consider implementing circuit breaker patterns for external service calls within transactions</li></ul></div></article><hr><div class=post-info><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span class=tag><a href=https://ifan0927.github.io/my-tech-blog/tags/gorm/>gorm</a></span>
<span class=tag><a href=https://ifan0927.github.io/my-tech-blog/tags/transaction/>transaction</a></span>
<span class=tag><a href=https://ifan0927.github.io/my-tech-blog/tags/error-handling/>error-handling</a></span>
<span class=tag><a href=https://ifan0927.github.io/my-tech-blog/tags/go/>go</a></span>
<span class=tag><a href=https://ifan0927.github.io/my-tech-blog/tags/backend/>backend</a></span></p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
<span class=tag><a href=https://ifan0927.github.io/my-tech-blog/categories/development/>development</a></span>
<span class=tag><a href=https://ifan0927.github.io/my-tech-blog/categories/database/>database</a></span></p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
549字</p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
2025-12-25 00:00</p></div><div class=pagination><div class=pagination__buttons><span class="button next"><a href=https://ifan0927.github.io/my-tech-blog/posts/2025-12-15_note/><span class=button__text>Lease Lifecycle Management: CRUD Design for Property Management System</span>
<span class=button__icon>→</span></a></span></div></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/my-tech-blog/bundle.min.ad54ad97364f77ede35def9096b162bb1f0b3973aa50b080f5e82fa147f6882e2a7200d7535adbf9b51bebf939f1c1ca9bbe6be87530092aca720eac4a226fda.js integrity="sha512-rVStlzZPd+3jXe+QlrFiux8LOXOqULCA9egvoUf2iC4qcgDXU1rb+bUb6/k58cHKm75r6HUwCSrKcg6sSiJv2g=="></script></body></html>